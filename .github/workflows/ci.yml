name: CI

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint-test:
    name: Lint and Test (${{ matrix.dir }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir:
          - PDP/Task1 Plant_Growth_Module
          - PDP/Task2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ruff black pytest

      - name: Install project (if pyproject exists)
        if: ${{ hashFiles(format('{0}/pyproject.toml', matrix.dir)) != '' }}
        run: |
          pip install -e "${{ matrix.dir }}"

      - name: Ruff
        run: |
          cd "${{ matrix.dir }}"
          ruff check .

      - name: Black (check)
        run: |
          cd "${{ matrix.dir }}"
          black --check .

      - name: Pytest (if tests exist)
        if: ${{ hashFiles(format('{0}/**/test_*.py', matrix.dir), format('{0}/**/*_test.py', matrix.dir)) != '' }}
        run: |
          cd "${{ matrix.dir }}"
          pytest -q

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install markdownlint
        run: |
          npm install -g markdownlint-cli2

      - name: Lint markdown
        run: |
          markdownlint-cli2 "**/*.md" "#**/node_modules/**"

  file-size-check:
    name: File Size Check (10 MB)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail on large files
        run: |
          MAX_BYTES=$((10 * 1024 * 1024))
          echo "Checking for files larger than ${MAX_BYTES} bytes (10 MB)..."
          LARGE_FILES=$(find . -type f -size +${MAX_BYTES}c \
            -not -path "./.git/*" \
            -not -path "./.github/*")

          if [ -n "$LARGE_FILES" ]; then
            echo "::error::Files exceeding 10 MB detected:"
            echo "$LARGE_FILES"
            exit 1
          fi

          echo "No files over 10 MB found."
