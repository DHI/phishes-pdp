name: Branch Protection Checks

# This workflow runs checks on pull requests to enforce code quality
# and security standards before code can be merged to main.

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check that PR follows branch protection guidelines
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify PR is not directly from fork
        run: |
          echo "Checking PR source..."
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          
      - name: Check PR title and description
        run: |
          if [ -z "${{ github.event.pull_request.title }}" ]; then
            echo "Error: PR title is required"
            exit 1
          fi
          echo "PR validation passed"

  # Prevent direct pushes to main (this job will fail if push is to main)
  prevent-direct-push:
    name: Prevent Direct Push to Main
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Fail if direct push to main
        run: |
          echo "::error::Direct pushes to main branch are not allowed!"
          echo "::error::Please create a pull request instead."
          echo "This push should have been blocked by branch protection rules."
          echo "Please ensure branch protection is properly configured."
          exit 1

  # Basic code quality checks
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Check for common issues
        run: |
          echo "Running basic code quality checks..."
          
          # Check for secrets or sensitive data
          echo "Checking for potential secrets..."
          if grep -r -i -E "(password|api_key|secret|token|private_key)" . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" 2>/dev/null | grep -v "SECURITY.md" | grep -v "# "; then
            echo "Warning: Potential secrets found in code. Please review."
            # Note: We don't fail here as these might be false positives
          else
            echo "No obvious secrets detected."
          fi
          
          # Check that important files exist
          echo "Checking for important files..."
          if [ ! -f "README.md" ]; then
            echo "Warning: README.md not found"
          fi
          
          if [ ! -f ".gitignore" ]; then
            echo "Warning: .gitignore not found"
          fi
          
          if [ ! -f "SECURITY.md" ]; then
            echo "Warning: SECURITY.md not found"
          fi
          
          if [ ! -f ".github/CODEOWNERS" ]; then
            echo "Warning: CODEOWNERS file not found"
          fi
          
          echo "Code quality checks completed"

  # Security scanning
  security-check:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run basic security checks
        run: |
          echo "Running security checks..."
          
          # Check for executable files that shouldn't be committed
          echo "Checking for unexpected executable files..."
          find . -type f -executable -not -path "./.git/*" | while read file; do
            echo "Found executable: $file"
          done
          
          echo "Security checks completed"
